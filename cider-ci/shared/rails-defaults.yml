git_options:
  submodules:
    include_match: '^.*$'

traits:
  PostgreSQL: true
  asdf: true

templates:
  database:
    src: 'cider-ci/templates/database.yml'
    dest: 'config/database.yml'

environment_variables:
  RAILS_ENV: test
  RACK_ENV: test
  PGVERSION: '15'
  PGPORT: '54{{PGVERSION}}'

scripts:
  bundle:
    exclusive_executor_resource: ci_ui_setup_ruby
    timeout: 10 Minutes
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      ./bin/env/ruby-setup
      bundle

  create-database:
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      source database/bin/pg_env
      bundle exec rails db:create
      bundle exec rails db:reset
    start_when:
      bundled:
        script_key: bundle

  test:
    start_when:
      bundled:
        script_key: bundle
      database_created:
        script_key: create-database

  delete-database:
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      source database/bin/pg_env

      bundle exec rake db:pg:terminate_connections db:drop
    ignore_state: true
    start_when:
      tested:
        script_key: test
        states: [aborted, passed, failed, skipped]

